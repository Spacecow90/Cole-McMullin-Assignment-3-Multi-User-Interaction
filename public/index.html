<!DOCTYPE html>
<html>
    <head>
        <title>The Maze Test</title>
        <meta charset="utf-8" />
        
        <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.4/dist/aframe-extras.min.js"></script>
        <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>
        <script src="js/gameController.js"></script>
        
    </head>

    <body>
        <!-- our buttond to tell others -->
        <!-- <button id="red" style="background-color:rgb(255, 0, 0); color:rgb(255, 255, 255)">RED</button>
        <button id="blue" style="background-color:rgb(0, 0, 255); color:rgb(255, 255, 255)">BLUE</button> -->

        <a-scene background="color:rgb(0, 0, 0);">
            <a-assets timeout="10000">
                <img id="maze_texture" src="assets/images/mossy_brick_diff_4k.jpg" crossorigin="anonymous">
                <a-asset-item id="maze_model"response-type="arraybuffer" src="assets/models/maze.gltf"></a-asset-item>
                <a-asset-item id="mazeRooms_model"response-type="arraybuffer" src="assets/models/mazeRooms.gltf"></a-asset-item>
                <a-asset-item id="navMesh" response-type="arraybuffer" src="assets/models/navMesh.gltf"></a-asset-item>
                <a-asset-item id="redNavMesh" response-type="arraybuffer" src="assets/models/redNavMesh.gltf"></a-asset-item>
                <a-asset-item id="yellowNavMesh" response-type="arraybuffer" src="assets/models/yellowNavMesh.gltf"></a-asset-item>
                <a-asset-item id="greenNavMesh" response-type="arraybuffer" src="assets/models/greenNavMesh.gltf"></a-asset-item>
                <a-asset-item id="blueNavMesh" response-type="arraybuffer" src="assets/models/blueNavMesh.gltf"></a-asset-item>
                <!--"various low poly character poses" (https://skfb.ly/opxT6) by NataN is licensed under Creative Commons Attribution (http://creativecommons.org/licenses/by/4.0/).-->
                <a-asset-item id="statues_model" response-type="arraybuffer" src="assets/models/statues.gltf"></a-asset-item>
            </a-assets>

            <!--CameraRig setup uses nav meshes-->
            <a-entity
                id="cameraRig"
                movement-controls="speed: 0.4; constrainToNavMesh: true;"
            >
                <a-entity id="camera" camera position="0 1.65 0" look-controls>
                    <a-entity cursor="rayOrigin:mouse;" raycaster="far:20; interval:200; objects:.interactive"></a-entity>
                </a-entity> 
            </a-entity
            ><!-- End Camera Rig -->

            <a-entity class="ground" id="startGround" geometry="primitive:plane; width:15; height:15;" material="color:white;" position="0 0.01 0" rotation="-90 0 0"></a-entity>
            <a-entity class="ground" id="mazeGround" geometry="primitive:plane; width:80; height:70;" material="color:white;" position="-15 0.01 -45" rotation="-90 0 0"></a-entity>
            <a-entity class="ground" id="guideGround" geometry="primitive:plane; width:30; height:30;" material="color:white;" position="50 0.01 -60" rotation="-90 0 0"></a-entity>
            <a-entity class="ground" id="endGround" geometry="primitive:plane; width:40; height:20;" material="color:white;" position="0 0.01 -93" rotation="-90 0 0"></a-entity>

            <!-- makes player the runner-->
            <a-entity id="runner_button" position="2 0.6 -1">
                <a-entity class="button interactive" position="0 0.6 0" geometry="primitive:cylinder; radius:0.15; height:0.2;" material="color:rgb(255, 100, 100)"
                            animation__mouseenter="property:material.color; type:color; to:rgb(255, 0, 0); startEvents:mouseenter; dur:200"
                            animation__mouseleave="property:material.color; type:color; to:rgb(255, 100, 100); startEvents:mouseleave; dur:200"
                            animation__click="property:position.y; from:0.55; to:0.6; startEvents:click; dur:300" shadow></a-entity>
                <a-entity position="0 0.3 0" geometry="primitive:box; width:0.5; depth:0.5; height:0.6;" material="color:rgb(255, 255, 255)" shadow></a-entity>
            </a-entity>

            <!-- makes player the guide -->
            <a-entity id="guide_button" position="-2 0.6 -1">
                <a-entity class="button interactive" position="0 0.6 0" geometry="primitive:cylinder; radius:0.15; height:0.2;" material="color:rgb(100, 100, 255)"
                            animation__mouseenter="property:material.color; type:color; to:rgb(0, 0, 255); startEvents:mouseenter; dur:200"
                            animation__mouseleave="property:material.color; type:color; to:rgb(100, 100, 255); startEvents:mouseleave; dur:200"
                            animation__click="property:position.y; from:0.55; to:0.6; startEvents:click; dur:300" shadow></a-entity>
                <a-entity position="0 0.3 0" geometry="primitive:box; width:0.5; depth:0.5; height:0.6;" material="color:rgb(255, 255, 255)" shadow></a-entity>
            </a-entity>

            <a-entity id="endMaze_button" position="-12 0.6 -75">
                <a-entity class="button interactive" position="0 0.6 0" geometry="primitive:cylinder; radius:0.15; height:0.2;" material="color:rgb(100, 255, 100)"
                            animation__mouseenter="property:material.color; type:color; to:rgb(0, 255, 0); startEvents:mouseenter; dur:200"
                            animation__mouseleave="property:material.color; type:color; to:rgb(100, 255, 100); startEvents:mouseleave; dur:200"
                            animation__click="property:position.y; from:0.55; to:0.6; startEvents:click; dur:300" shadow></a-entity>
                <a-entity position="0 0.3 0" geometry="primitive:box; width:0.5; depth:0.5; height:0.6;" material="color:rgb(255, 255, 255)" shadow></a-entity>
            </a-entity>
            <a-entity id = "door_buttons" position="50 0.6 -70">
                <a-entity id="redDoor_button" position="-5 0 0">
                    <a-entity position="0 0 0" geometry="primitive:box; width:0.5; depth:0.5; height:1;" material="color:rgb(255, 255, 255)" shadow>
                        <a-entity class="button interactive" position="0 0.5 0" geometry="primitive:cylinder; radius:0.15; height:0.2;" material="color:rgb(255, 50, 50)"
                            animation__mouseenter="property:material.color; type:color; to:rgb(255, 0, 0); startEvents:mouseenter; dur:200"
                            animation__mouseleave="property:material.color; type:color; to:rgb(255, 50, 50); startEvents:mouseleave; dur:200"
                            animation__click="property:position.y; from:0.45; to:0.5; startEvents:click; dur:300" shadow></a-entity>
                    </a-entity>
                    
                    
                </a-entity>
                <a-entity id="yellowDoor_button" position="0 0 0">
                    <a-entity position="0 0 0" geometry="primitive:box; width:0.5; depth:0.5; height:1;" material="color:rgb(255, 255, 255)" shadow>
                        <a-entity class="button interactive" position="0 0.5 0" geometry="primitive:cylinder; radius:0.15; height:0.2;" material="color:rgb(255, 255, 50)"
                            animation__mouseenter="property:material.color; type:color; to:rgb(255, 255, 0); startEvents:mouseenter; dur:200"
                            animation__mouseleave="property:material.color; type:color; to:rgb(255, 255, 50); startEvents:mouseleave; dur:200"
                            animation__click="property:position.y; from:0.45; to:0.5; startEvents:click; dur:300" shadow></a-entity>
                    </a-entity>
                    
                    
                </a-entity>
                <a-entity id="greenDoor_button" position="5 0 0">
                    <a-entity position="0 0 0" geometry="primitive:box; width:0.5; depth:0.5; height:1;" material="color:rgb(255, 255, 255)" shadow>
                        <a-entity class="button interactive" position="0 0.5 0" geometry="primitive:cylinder; radius:0.15; height:0.2;" material="color:rgb(50, 255, 50)"
                            animation__mouseenter="property:material.color; type:color; to:rgb(0, 255, 0); startEvents:mouseenter; dur:200"
                            animation__mouseleave="property:material.color; type:color; to:rgb(50, 255, 50); startEvents:mouseleave; dur:200"
                            animation__click="property:position.y; from:0.45; to:0.5; startEvents:click; dur:300" shadow></a-entity>
                    </a-entity>
                    
                    
                </a-entity>
                <a-entity id="blueDoor_button" position="10 0 0 ">
                    <a-entity position="0 0 0" geometry="primitive:box; width:0.5; depth:0.5; height:1;" material="color:rgb(255, 255, 255)" shadow>
                        <a-entity class="button interactive" position="0 0.5 0" geometry="primitive:cylinder; radius:0.15; height:0.2;" material="color:rgb(50, 50, 255)"
                            animation__mouseenter="property:material.color; type:color; to:rgb(0, 0, 255); startEvents:mouseenter; dur:200"
                            animation__mouseleave="property:material.color; type:color; to:rgb(50, 50, 255); startEvents:mouseleave; dur:200"
                            animation__click="property:position.y; from:0.45; to:0.5; startEvents:click; dur:300" shadow></a-entity>
                    </a-entity>
                    
                    
                </a-entity>
            </a-entity>
            <!--all navmeshes are defined, the default navmesh is the actual one that is used, 
            whereas the others are meant to load in the assets so they can be swapped out.-->
            <a-entity id="navmesh" nav-mesh visible="false" gltf-model="#navMesh" ></a-entity>
            <a-entity id="allnavmesh" visible="false" gltf-model="#navMesh" ></a-entity>
            <a-entity id="rednavmesh" visible="false" gltf-model="#redNavMesh" ></a-entity>
            <a-entity id="yellownavmesh" visible="false" gltf-model="#yellowNavMesh" ></a-entity>
            <a-entity id="greennavmesh" visible="false" gltf-model="#greenNavMesh" ></a-entity>
            <a-entity id="bluenavmesh" visible="false" gltf-model="#blueNavMesh" ></a-entity>

            <a-entity id="maze">
                <!--Door in the maze-->
                <!--red door-->
                <a-entity id="redDoorFrame" position="-51.5 1.5 -63">
                    <a-entity id="redDoor" doorInfo geometry="primitive: box; height: 4; width: 4; depth:0.5;" material="color:rgb(255, 50, 50)"  
                    animation__open="property:position.y; from:0; to:-3.1; startEvents:openDoor; dur:300" 
                    animation__close="property:position.y; from:-3.1; to:0; startEvents:closeDoor; dur:300" shadow>
                    </a-entity>
                </a-entity>
                <!--yellow door-->
                <a-entity id="yellowDoorFrame" position="-23 1.5 -26" rotation="0 90 0">
                    <a-entity id="yellowDoor" doorInfo geometry="primitive: box; height: 4; width: 4; depth:0.5;" material="color:rgb(255, 255, 50)"  
                    animation__open="property:position.y; from:0; to:-3.1; startEvents:openDoor; dur:300" 
                    animation__close="property:position.y; from:-3.1; to:0; startEvents:closeDoor; dur:300" shadow>
                    </a-entity>
                </a-entity>
                <!--green door-->
                <a-entity id="greenDoorFrame" position="17 1.5 -40" rotation="0 90 0">
                    <a-entity id="greenDoor" doorInfo geometry="primitive: box; height: 4; width: 4; depth:0.5;" material="color:rgb(50, 250, 50)"  
                    animation__open="property:position.y; from:0; to:-3.1; startEvents:openDoor; dur:300" 
                    animation__close="property:position.y; from:-3.1; to:0; startEvents:closeDoor; dur:300" shadow>
                    </a-entity>
                </a-entity>
                <!--blue door-->
                <a-entity id="blueDoorFrame" position="-21 1.5 -51">
                    <a-entity id="blueDoor" doorInfo geometry="primitive: box; height: 4; width: 5; depth:0.5;" material="color:rgb(50, 50, 250)"  
                    animation__open="property:position.y; from:0; to:-3.1; startEvents:openDoor; dur:300" 
                    animation__close="property:position.y; from:-3.1; to:0; startEvents:closeDoor; dur:300" shadow>
                    </a-entity>
                </a-entity>
                <!--Maze Meshes-->
                <a-entity id="maze" position="0 1 0" gltf-model="#maze_model" shadow></a-entity>
                <a-entity id="mazeRooms" position="0 1 0"  gltf-model="#mazeRooms_model" shadow></a-entity>
                <a-entity id="statues" position="0 0.1 0"  gltf-model="#statues_model" shadow></a-entity>
            </a-entity>
            
            <a-entity environment="preset:default; playArea:10; stageSize:300"></a-entity>
        </a-scene>

        <!-- this is magic code created when the node server runs -->
        <!-- putting at the bottom of body to let body load first before we try to query for elements -->
        <!-- //VERY HANDY! https://socket.io/docs/v4/emit-cheatsheet/ -->
        <script src="/socket.io/socket.io.js"></script>
        <script>
            const socket = io();

            let playerRole = "unassigned";
            
            socket.on('connect', (userData) => {
                console.log('I exist!');

                //put code here so that we know that socket.io has initailized ...
                document.querySelector('#runner_button').querySelector('.button').addEventListener('click', function(){
                    assignRole("runner");
                });
                document.querySelector('#guide_button').querySelector('.button').addEventListener('click', function(){
                    assignRole("guide");
                });
                document.querySelector('#endMaze_button').querySelector('.button').addEventListener('click', function(){
                    socket.emit('endmaze');
                });

                //door button functions
                document.querySelector('#redDoor_button').querySelector('.button').addEventListener('click', function(){
                    socket.emit('togglered');
                });
                document.querySelector('#yellowDoor_button').querySelector('.button').addEventListener('click', function(){
                    socket.emit('toggleyellow');
                });
                document.querySelector('#greenDoor_button').querySelector('.button').addEventListener('click', function(){
                    socket.emit('togglegreen');
                });
                document.querySelector('#blueDoor_button').querySelector('.button').addEventListener('click', function(){
                    socket.emit('toggleblue');
                });
            });
            //assigns the local player role and then calls a function to assign it to the second player
            function assignRole(buttonID)
            {
            playerRole = buttonID;
            console.log("I am a "+playerRole);
            teleportPlayer(playerRole, "start");
            socket.emit(playerRole);
            }

            
            //need to teleport players
            socket.on('assignOtherRole', (data) => {
               
                if(data == "runner")
                {   
                    //assigns a role only to the person who didn't click the button, the opposite of the one the player who chose picked. 
                    if(playerRole=="unassigned")
                    {
                        console.log("I am a guide");
                        playerRole = "guide";
                        //teleport the player to the guide location
                        teleportPlayer(playerRole,"start");
                        
                    }
                }
                //if the player clicked the guider button, make the other player the runner
                else if (data == "guide")
                {
                    if(playerRole=="unassigned")
                    {
                        console.log("I am a runner");
                        playerRole = "runner";
                        //teleport the player to the runner location
                        teleportPlayer(playerRole,"start");
                    }
                }

                
            });
            //called when the runner reached the end of the maze
            socket.on('competitive_start', (data) => {
                console.log("maze section completed");
                teleportPlayer(playerRole,"end");
            });
            //deals with opening and closing doors for the players
            socket.on('door_control', (data) => {
                console.log("Door action: "+data)
                moveDoor(data);
            });
            
        </script>
    </body>
</html>
